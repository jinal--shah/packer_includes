# vim: ts=4 st=4 sr noet smartindent syntax=make:
# BUILD_GIT_*: used to AWS-tag the built AMI, and generate its unique name
#              so we can trace its providence later.
#
# ... if the including product-role dir contains a custom packer.json
# .e.g because the default json is unsuitable, it will be used
# instead of the default
CUSTOM_JSON := $(strip $(wildcard packer.json))
ifeq ($(CUSTOM_JSON),)
	PACKER_JSON=packer_includes/json/product.default.json
else
	PACKER_JSON=packer.json
endif

export PACKER_JSON

# ... to rebuild using same version of tools, we can't trust the git tag
# but the branch, sha and repo, because git tags are mutable and movable.
export BUILD_GIT_BRANCH=$(shell git describe --contains --all HEAD)
export BUILD_GIT_SHA=$(shell git rev-parse --short=$(GIT_SHA_LEN) --verify HEAD)
export BUILD_GIT_REPO=$(shell   \
	git remote show -n origin   \
	| grep '^ *Push *'          \
	| awk {'print $$NF'}        \
)
export BUILD_GIT_ORG=$(shell \
	echo $(BUILD_GIT_REPO)   \
	| sed -e 's!.*[:/]\([^/]\+\)/.*!\1!' \
)
export BUILD_TIME=$(shell date +%Y%m%d%H%M%S)

