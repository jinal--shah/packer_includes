# vim: ts=4 st=4 sr noet smartindent syntax=make:
# AMI_SOURCE_ID: ami that this new one builds on, determined by make
export AMI_SOURCE_ID?=$(shell                                            \
	aws --cli-read-timeout 10 ec2 describe-images --region $(AWS_REGION) \
	--filter 'Name=manifest-location,Values=$(AMI_SOURCE_FILTER)'        \
	--filter 'Name=tag:os,Values=$(AMI_SOURCE_OS)'                       \
	--filter 'Name=tag:os_release,Values=$(AMI_SOURCE_OS_RELEASE)'       \
	--filter 'Name=tag:build_git_org,Values=$(AMI_SOURCE_GIT_ORG)'       \
	--filter 'Name=tag:build_git_branch,Values=$(AMI_SOURCE_GIT_BRANCH)' \
	--filter 'Name=tag:channel,Values=$(AMI_SOURCE_CHANNEL)'             \
	--query 'Images[*].[ImageId,CreationDate]'                           \
	--output text                                                        \
	| sort -k2 | tail -1 | awk {'print $$1'}                             \
)
export AMI_OS=$(AMI_SOURCE_OS)
export AMI_OS_RELEASE=$(AMI_SOURCE_OS_RELEASE)
export AMI_OS_INFO=$(AMI_OS)-$(AMI_OS_RELEASE)
export AMI_NAME_GIT_INFO=$(BUILD_GIT_SHA)-$(BUILD_GIT_BRANCH)
